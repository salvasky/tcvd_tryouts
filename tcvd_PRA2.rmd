---
title: "Tipologia i Cicle de Vida de les Dades. Prctica 2"
author: "*Salva Sanchis Beneseit* i *Joan Manuel Lopez Ruiz*"
date: '`r format(Sys.Date(),"%e %B de %Y")`'
output:
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
library(dplyr)
library(ggplot2)

```

# 1. Introducci贸. Descripci贸 del dataset  
Hem utilitzat el dataset "Titanic: Machine Learning from Disaster", disponible a https://www.kaggle.com/c/titanic

Aquest fam贸s joc de dades cont茅 informaci贸 sobre els passatgers que viatjaven al Titanic quan es va enfonsar, el 15 d'Abril del 1912. Les variables incloses en el joc de dades s贸n:


| **Variable** | **Definition**                  | **Key**                                        |
|--------------|---------------------------------|------------------------------------------------|
| survival     | Ha sobreviscut                  | 0 = No, 1 = S铆                                 |
| pclass       | Classe                          | 1 = 1a, 2 = 2a, 3 = 3a                         |
| sex          | G猫nere                          |                                                |
| Age          | Edat en anys                    |                                                |
| sibsp        | \# de germans / c貌njuges a bord |                                                |
| parch        | \# de pares / fills a bord      |                                                |
| ticket       | N煤mero de bitllet               |                                                |
| fare         | Preu del bitllet                |                                                |
| cabin        | N煤mero de cabina                |                                                |
| embarked     | Port d'embarcament              | C = Cherbourg, Q = Queenstown, S = Southampton |


A la pgina de Kaggle, com que el dataset es presenta com a material de base per a un exercici de machine learning, es divideix el datatset en un grup 'train' i un grup 'test'. La idea 茅s utilitzar el grup 'train' per elaborar un model que pugui predir la superviv猫ncia dels passatgers del grup 'test'.

A nosaltres, en canvi, ens interessa aquest dataset per fer un estudi d'inter猫s sociol貌gic/hist貌ric, en el qual no ens centrem en l'accident del Titanic ni en els 铆ndex de superviv猫ncia, sin贸 que aprofitem la informaci贸 del dataset per aprofundir sobre factors demogrfics i econ貌mics que ens ajudin a construir una imatge del moviment migratori envers els EUA a principis del segle XX. En aquest sentit doncs, utilitzarem el joc de dades complet, ajuntant els grups 'train' i 'test' i descartant la variable 'survival', i plantejarem preguntes com: viatjar era m茅s car pels homes que per les dones? Els preus dels bitllets es definien tenint en compte l'edat del passatger? Viatjaven m茅s nens a tercera classe que a primera? Viatjaven m茅s homes joves a tercera classe?  

# 2. Integraci贸 i selecci贸 de les dades d'inter猫s a analitzar  

# 3. Neteja de les dades  

## 3.1 Zeros o elements buits  

## 3.2 Valors extrems (outliers)  

# 4. Anlisi de les dades  
En aquesta secci贸 farem l'anlisi de les dades sota estudi. En concret estem interessats en els seg眉ents aspectes:  

* Difer猫ncia de tarifa en funci贸 del g猫nere del passatger.  
* Relaci贸 entre el port d'embarcament i la classe.  
* Mitjana d'edat dels passatgers a cadascuna de les classes.  

Abans de comen莽ar, per貌, cal carregar les dades del csv preparat i transformar la variable Pclass de num猫rica a categ貌rica.  

```{r}
# Lectura del fitxer csv preprocessat
titanic_df <- read.csv("data/titanic.csv")

# Conversi贸 de la variable Pclass a categ貌rica
titanic_df$Pclass <- as.factor(titanic_df$Pclass)

```

## 4.1 Prova 1. Difer猫ncia de tarifa en funci贸 del g猫nere del passatger.  
En aquesta prova volem comprovar si hi ha difer猫ncies en la quantitat mitjana que han pagat homes i dones per a embarcar.  

### 4.1.1 Selecci贸 dels grups de dades a analitzar/comparar  
En aquest cas farem una anlisi d'una variable num猫rica *Fare* respecte una variable categ貌rica *Sex*. Volem fer una prova de contrast d'hip貌tesis en la que ens plantegem si en mitjana homes i dones han pagat el mateix pels seus bitllets.  

Abans de comen莽ar a plantejar el test estad铆stic visualitzarem les difer猫ncies en la distribuci贸 de la variable *Fare* en funci贸 de la variable *Sex* amb una grfica boxplot.  

```{r}
# Boxplot tarifa segons sexe
ggplot(aes(y=Fare, x=Sex), data=titanic_df) + geom_boxplot()
```

Veiem que, de mitjana, les dones paguen m茅s que els homes. Tamb茅 veiem, per貌, que aquesta difer猫ncia sembla petita si tenim en compte la distribuci贸 total de la variable 'Fare' sobre els dos grups. La nostra prova doncs consistir a determinar si la difer猫ncia de preus entre dones i homes 茅s estad铆sticament significativa. D'acord amb les nostres observacions plantegem les seg眉ents hip貌tesis nul路la i alternativa:  

H~0~ : ~fare_f~ = ~fare_m~  

H~1~ : ~fare_f~ \> ~fare_m~  

* *Hip貌tesi nul路la*: les mitjanes de preu entre homes i dones 茅s igual  
* *Hip貌tesi alternativa*: les dones paguen un preu m茅s alt que els homes  


### 4.1.2 Comprovaci贸 de la normalitat i de la varincia  

**Comprovaci贸 de la normalitat**  
En primer lloc farem una validaci贸 de la normalitat de la distribuci贸 de la variable *Fare*, tant visual amb una grfica QQ-plot, com mitjan莽ant el test estad铆stic de Shapiro-Wilk.  

```{r}
# Comprovaci贸 visual amb QQ-plot
qqnorm(titanic_df$Fare)
qqline(titanic_df$Fare, col='red')

# Test de Shapiro-Wilk
shapiro.test(titanic_df$Fare)

```

La inspecci贸 de la grfica QQ-plot revela que la variable *Fare* no segueix la l铆nia vermella que marca la distribuci贸 normal. El resultat del test de Shapiro-Wilk, en el que obtenim un p-value de l'ordre de $10^{-16}$ ens permet descartar la hip貌tesi nul路la i arribar a la conclusi贸 de que la variable *Fare* no segueix una distribuci贸 normal.  

Malgrat el resultat de les proves i donat que farem tests sobre la mitjana, podem assumir segons el Teorema del L铆mit Central que la distribuci贸 de les mitjanes ser normal ja que disposem d'un nombre prou elevat de mostres.  

**Comprovaci贸 de la varincia**  
Per tal de determinar el tipus de test estad铆stic a aplicar en aquest cas cal comprovar pr猫viament les varincies de les dues distribucions. Dividirem les mostres de la variable *Fare* segons el valor de la variable *Sex* i aplicarem la funci贸 *var.test()*.    

```{r}
# Les varincies del preu en funci贸 del sexe s贸n iguals
fare_m <- titanic_df[titanic_df$Sex == 'male',]$Fare
fare_f <- titanic_df[titanic_df$Sex == 'female',]$Fare
var.test(fare_m,fare_f,conf.level = 0.95)

```

El valor de p-value resultant, de l'ordre de $10^{-16}$, ens permet concloure que les dues varincies s贸n diferents amb un nivell de confian莽a del 95%. Donat que en aquest cas no es dona la condici贸 d'homocedasticitat aplicarem un test sobre la mitjana de dues mostres independents, unilateral, amb varincia desconeguda i diferent.  

```{r}
# Aplicaci贸 de la funci贸 t.test() per al test estad铆stic unilateral
t.test(fare_f, fare_m, alternative = "greater", var.equal = FALSE)
```

La prova estad铆stica ens indica, amb un valor p per sota del nivell de significaci贸, que podem rebutjar la hip貌tesi nul路la. Per tant la conclusi贸 茅s que la difer猫ncia de preu entre homes i dones 茅s estad铆sticament significativa, i les dones paguen m茅s que els homes.  

Repetim la prova amb el test no param猫tric de Wilcoxon, arribant a la mateixa conclusi贸:  

```{r}
# Aplicaci贸 de la funci贸 wilcox.test() per al test estad铆stic unilateral
wilcox.test(fare_f, fare_m, alternative = 'greater', conf.level=0.95)
```

Despr茅s d'aplicar els dos tests, els valors de p-Value resultants ens permeten rebutjar la hipotesi nul路la i afirmar, amb un nivell de confian莽a del 95%, que en mitjana les dones paguen m茅s pel bitllet que els homes.  

Aquesta anlisi no ha tingut en compte la classe en la que viatgen els passatgers, per tant caldria veure si aquest resultat 茅s degut a que les dones viatgen, majoritariament, a primera i segona classe.  

### 4.1.3 Aplicaci贸 de les proves estad铆stiques adients  
Donat que en aquest cas no es dona la condici贸 d'homocedasticitat aplicarem un test sobre la mitjana de dues mostres independents, unilateral, amb varincia desconeguda i diferent.  

```{r}
# Aplicaci贸 de la funci贸 t.test() per al test estad铆stic unilateral
t.test(fare_f, fare_m, alternative = "greater", var.equal = FALSE)
```

La prova estad铆stica ens indica, amb un valor p per sota del nivell de significaci贸, que podem rebutjar la hip貌tesi nul路la. Per tant la conclusi贸 茅s que la difer猫ncia de preu entre homes i dones 茅s estad铆sticament significativa, i les dones paguen m茅s que els homes.  

Repetim la prova amb el test no param猫tric de Wilcoxon, arribant a la mateixa conclusi贸:  

```{r}
# Aplicaci贸 de la funci贸 wilcox.test() per al test estad铆stic unilateral
wilcox.test(fare_f, fare_m, alternative = 'greater', conf.level=0.95)
```

Despr茅s d'aplicar els dos tests, els valors de p-Value resultants ens permeten rebutjar la hipotesi nul路la i afirmar, amb un nivell de confian莽a del 95%, que en mitjana les dones paguen m茅s pel bitllet que els homes.  

Aquesta anlisi no ha tingut en compte la classe en la que viatgen els passatgers, per tant caldria veure si aquest resultat 茅s degut a que les dones viatgen, majoritariament, a primera i segona classe.  

## 4.2 Prova 2. Relaci贸 entre el port d'embarcament i la classe.  
En aquesta provem volem comprovar si hi ha algun tipus de relaci贸 entre el port d'embarcament i la classe en la que viatgen els passatgers que hi embarquen.   

### 4.2.1 Selecci贸 dels grups de dades a analitzar/comparar  
En aquest cas farem l'anlisi de dues variables categ貌riques *Embarked* i *PClass* per tant caldr aplicar un test Chi-squared.  

A la taula seg眉ent visualitzarem quants atributs hi ha per a cada combinaci贸 de port d'embarcament i classe.  

```{r}

table(titanic_df$Pclass, titanic_df$Embarked)
```

Sembla que el port d'embarcament influeix sobre la classe del passatger. Veiem, per exemple, que al port de Queenstown hi embarquen majoritriament passatgers de tercera classe, mentre que a Cherbourg s贸n m茅s nombrosos els passatgers de primera classe. D'acord amb aquesta observaci贸 plantegem les seg眉ents hip貌tesis nul路la i alternativa:  

H~0~: Les variables 'PClass' i 'Embarked' s贸n independents  

H~1~: Hi ha relaci贸 entre les variables 'PClass' i 'Embarked'  


### 4.2.2 Comprovaci贸 de la normalitat i de la varincia  
En aquest cas no aplica aquest apartat en tractar-se d'un test Chi-squared sobre dues variables categ貌riques.  

### 4.2.3 Aplicaci贸 de les proves estad铆stiques adients  
intro...  

```{r}
# Realitzaci贸 del test Chi-squared
cs <- chisq.test(titanic_df$Pclass, titanic_df$Embarked)
cs
#Comprovem que el valor esperat de les cel路les sigui superior a 5 en el 80% dels casos:
cs$expected
```

Els resultats del test de chi quadrat confirmen les nostres sospites. Rebutgem la hip貌tesi nul路la i acceptem la depend猫ncia de les dues variables amb un valor p \< 0.01  

## 4.3 Prova 3. Mitjana d'edat dels passatgers a cadascuna de les classes.  
En aquest cas el nostre objectiu 茅s comparar la mitjana d'edat dels passatgers del Titanic en funci贸 de la classe en la que viatjaven i comprovar si hi ha difer猫ncies entre elles. Ja que es tracta d'una comparaci贸 de mitjanes entre m茅s de dos grups de dades (al Titanic hi havia tres classes diferents) procedirem a aplicar un test d'ANOVA.  

Tal i com hem fet a la *Prova 1* el primer pas ser comprovar les distribucions de la variable *Age* en funci贸 de la variable *Pclass* amb grfiques de tipus boxplot.

```{r}
ggplot(aes(y=Age, x=Pclass), data=titanic_df) + geom_boxplot()
```

A les grfiques observem que a primera classe la mitjana d'edat dels viatgers 茅s m茅s elevada que a segona i tercera, i que la caixa que representa l'IQR est m茅s elevada, el que indica que l'edat dels passatgers a primera 茅s major que a les altres dues. A partir de la grfica es pot concloure que hi havia viatgers de m茅s edat a primera classe i, per altra banda, hi havia viatgers m茅s joves a tercera classe, quedant la segona classe en un intermig.  

### 4.3.1 Selecci贸 dels grups de dades a analitzar/comparar  
En aquest cas farem una anlisi de la variable num猫rica *Age* respecte la variable categ貌rica *Pclass*. Volem fer una prova de contrast d'hip貌tesis en la que ens plantegem si en mitjana l'edat dels passatgers 茅s la mateixa a totes les classes.  

Abans de comen莽ar a plantejar el test estad铆stic visualitzarem les difer猫ncies en la distribuci贸 de la variable *Age* en funci贸 de la variable *Pclass* amb una grfica boxplot. D'acord amb les nostres observacions plantegem les seg眉ents hip貌tesis nul路la i alternativa:  

Hip貌tesi nul路la: la mitjana d'edat a totes les classes 茅s la mateixa.  
Hip貌tesi alternativa: les mitjanes d'edat s贸n diferents a cada classe.  

### 4.3.2 Comprovaci贸 de la normalitat i de la varincia  

**Comprovaci贸 de la normalitat**  
En primer lloc farem una validaci贸 de la normalitat de la distribuci贸 de la variable *Fare*, tant visual amb una grfica QQ-plot, com mitjan莽ant el test estad铆stic de Shapiro-Wilk.  

```{r}
# Comprovaci贸 visual amb QQ-plot
qqnorm(titanic_df$Age)
qqline(titanic_df$Age, col='red')

# Test de Shapiro-Wilk
shapiro.test(titanic_df$Age)

```

La inspecci贸 de la grfica QQ-plot revela que la variable *Age* no segueix la l铆nia vermella que marca la distribuci贸 normal, especialment als extrems de l'eix dabscisses. El resultat del test de Shapiro-Wilk, en el que obtenim un p-value de l'ordre de $10^{-15}$ ens permet descartar la hip貌tesi nul路la i arribar a la conclusi贸 de que la variable *Age* no segueix una distribuci贸 normal.  

Malgrat el resultat de les proves i donat que farem tests sobre les mitjanes, podem assumir segons el Teorema del L铆mit Central que la distribuci贸 de les mitjanes ser normal ja que disposem d'un nombre prou elevat de mostres.  

**Comprovaci贸 de la varincia**  
Per tal de determinar el tipus de test estad铆stic a aplicar en aquest cas cal comprovar pr猫viament les varincies de les distribucions de la variable *Age* en funci贸 de la classe (variable *Pclass*).  

```{r}
# H0: Les varincies de l'edat en funci贸 de la classe s贸n iguals
#var.test(Age ~ Pclass, data=titanic_df, conf.level = 0.95)

```

El valor de p-value resultant, inferior al nivell de significan莽a, ens permet concloure que les varincies de la variable *Age* entre les diferents classes s贸n diferents amb un nivell de confian莽a del 95%.

### 4.3.3 Aplicaci贸 de les proves estad铆stiques adients  
Donat que en aquest cas no es dona la condici贸 d'homocedasticitat cal aplicar la prova no param猫trica de Kruskal-Wallis per a comprovar la validesa de la hip貌tesi nul路la.  

```{r}
# Test no param猫tric per a la comparaci贸 de m茅s de dos grups
#kruskal.test(Age ~ Pclass, data=titanic_df, conf.level=0.95)

```



# 5. Representaci贸 grfica dels resultats  
Al llarg d'aquest document s'han anat presentant les grfiques necessries per a la interpretaci贸 dels resultats obtinguts, aix铆 com per a la visualitzaci贸 de les distribucions de les variables a analitzar.  

# 6. Conclusions  

# 7. Codi font per a la resoluci贸 de la prctica  
El present document HTML ha estat generat amb RStudio a partir d'un fitxer Rmd (R-markdown) que cont茅 el codi necessari per al desenvolupament de la prctica plantejada. Podeu consultar el fitxer Rmd amb el codi font en aquest mateix repositori.